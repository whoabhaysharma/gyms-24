name: Deploy Backend & Webhook

on:
  push:
    branches: [ master ]
    paths:
      - 'bknd/**'
      - 'webhook/**'
      - 'docker-compose.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Navigate to project directory
            cd gyms-24 || exit 1
            
            # Pull latest changes
            git pull origin master
            
            # Stop running containers
            docker-compose stop backend webhook
            
            # Remove old containers
            docker-compose rm -f backend webhook
            
            # Rebuild and start services
            docker-compose up --build -d backend webhook
            
            # Cleanup unused images
            docker-compose image prune -f
