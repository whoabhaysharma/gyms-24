name: Deploy Changed Services

on:
  push:
    branches:
      - master
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      webhook-changed: ${{ steps.changes.outputs.webhook }}
      docker-compose-changed: ${{ steps.changes.outputs.docker-compose }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # Get the list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for changes in each service
          if echo "$CHANGED_FILES" | grep -q "^bknd/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^webhook/"; then
            echo "webhook=true" >> $GITHUB_OUTPUT
            echo "Webhook changes detected"
          else
            echo "webhook=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -q "docker-compose.yml\|\.env"; then
            echo "docker-compose=true" >> $GITHUB_OUTPUT
            echo "Docker compose or environment changes detected"
          else
            echo "docker-compose=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: self-hosted  # This will run on your EC2 instance
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend-changed == 'true' || 
      needs.detect-changes.outputs.webhook-changed == 'true' ||
      needs.detect-changes.outputs.docker-compose-changed == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create environment files
        run: |
          # Create backend .env if not exists
          if [ ! -f "./bknd/.env" ]; then
            cp "./bknd/.env.example" "./bknd/.env" 2>/dev/null || touch "./bknd/.env"
          fi
          
          # Create webhook .env if not exists  
          if [ ! -f "./webhook/.env" ]; then
            cp "./webhook/.env.example" "./webhook/.env" 2>/dev/null || touch "./webhook/.env"
          fi

      - name: Create Docker network
        run: |
          docker network create gyms24-net 2>/dev/null || true

      - name: Stop and remove changed services
        run: |
          # Function to stop and remove a service
          stop_service() {
            local service=$1
            echo "Stopping and removing $service..."
            docker compose stop $service 2>/dev/null || true
            docker compose rm -f $service 2>/dev/null || true
            # Also remove the image to force rebuild
            docker rmi "gyms24-${service}" 2>/dev/null || true
            docker rmi "gyms-24-${service}" 2>/dev/null || true
          }

          # Stop changed services
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" ]; then
            stop_service backend
          fi
          
          if [ "${{ needs.detect-changes.outputs.webhook-changed }}" == "true" ]; then
            stop_service webhook  
          fi
          
          # If docker-compose changed, restart infrastructure services
          if [ "${{ needs.detect-changes.outputs.docker-compose-changed }}" == "true" ]; then
            echo "Docker compose changes detected, checking infrastructure..."
            docker compose up -d postgres redis
          fi

      - name: Build and start changed services
        run: |
          # Build and start only the changed services
          SERVICES_TO_BUILD=""
          
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD backend"
            echo "Building backend service..."
          fi
          
          if [ "${{ needs.detect-changes.outputs.webhook-changed }}" == "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD webhook"
            echo "Building webhook service..."
          fi
          
          if [ ! -z "$SERVICES_TO_BUILD" ]; then
            echo "Building services: $SERVICES_TO_BUILD"
            # Build the changed services
            docker compose build $SERVICES_TO_BUILD
            # Start the changed services
            docker compose up -d $SERVICES_TO_BUILD
          fi

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          sleep 30
          
          # Check service health
          check_service() {
            local service=$1
            local port=$2
            echo "Checking $service health..."
            for i in {1..30}; do
              if curl -f "http://localhost:$port/health" 2>/dev/null; then
                echo "$service is healthy"
                return 0
              fi
              echo "Waiting for $service... (attempt $i/30)"
              sleep 10
            done
            echo "$service failed to become healthy"
            return 1
          }
          
          # Check changed services
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" ]; then
            check_service backend 3000 || echo "Backend health check failed"
          fi
          
          if [ "${{ needs.detect-changes.outputs.webhook-changed }}" == "true" ]; then
            check_service webhook 4000 || echo "Webhook health check failed"
          fi

      - name: Show running containers
        run: |
          echo "Currently running containers:"
          docker compose ps
          
          echo "Docker logs for recently started services:"
          if [ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" ]; then
            echo "=== Backend Logs ==="
            docker compose logs --tail=50 backend
          fi
          
          if [ "${{ needs.detect-changes.outputs.webhook-changed }}" == "true" ]; then
            echo "=== Webhook Logs ==="
            docker compose logs --tail=50 webhook
          fi

      - name: Cleanup old images
        run: |
          echo "Cleaning up dangling images..."
          docker image prune -f
          
          echo "Disk usage after cleanup:"
          docker system df